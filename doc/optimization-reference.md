# Sub2API ä¼˜åŒ–å¯¹ç…§å‚è€ƒ

> æœ¬æ–‡åŸºäº 88code (byebyecode) é¡¹ç›®æ¶æ„åˆ†æï¼Œå¯¹ç…§ Sub2API ç°æœ‰å®ç°æ ‡æ³¨çŠ¶æ€ã€‚
> å®šä½ä¸º"å·®å¼‚å¯¹ç…§å‚è€ƒ"ï¼Œä¸æ˜¯"æ‰§è¡Œå¾…åŠæ¸…å•"ã€‚
> æ‰€æœ‰ç»“è®ºä»¥å½“å‰ä»“åº“ä»£ç ä¸ºå‡†ï¼ˆæ ¸å¯¹æ—¥æœŸï¼š2026-02-12ï¼‰ã€‚
>
> çŠ¶æ€æ ‡è®°ï¼š`âœ… å·²å®ç°` / `âš ï¸ éƒ¨åˆ†å®ç°` / `âŒ æœªå®ç°` / `ğŸš« ä¸é€‚ç”¨`

---

## ç›®å½•

- [ä¸€ã€ç°æœ‰èƒ½åŠ›æ¦‚è§ˆï¼ˆå·²å®ç°ï¼‰](#ä¸€ç°æœ‰èƒ½åŠ›æ¦‚è§ˆå·²å®ç°)
- [äºŒã€å¾…å®æ–½ä¼˜åŒ–ï¼ˆçœŸæ­£çš„ Gapï¼‰](#äºŒå¾…å®æ–½ä¼˜åŒ–çœŸæ­£çš„-gap)
- [ä¸‰ã€è¿è¥å†³ç­–é¡¹ï¼ˆæŒ‰éœ€è¯„ä¼°ï¼‰](#ä¸‰è¿è¥å†³ç­–é¡¹æŒ‰éœ€è¯„ä¼°)
- [é™„å½• Aï¼š88code æ¶æ„å‚è€ƒï¼ˆä¸ç›´æ¥é€‚ç”¨ï¼‰](#é™„å½•-a88code-æ¶æ„å‚è€ƒä¸ç›´æ¥é€‚ç”¨)
- [é™„å½• Bï¼šæŠ€æœ¯æ ˆå¯¹æ¯”ï¼ˆä¿®æ­£ç‰ˆï¼‰](#é™„å½•-bæŠ€æœ¯æ ˆå¯¹æ¯”ä¿®æ­£ç‰ˆ)

---

## ä¸€ã€ç°æœ‰èƒ½åŠ›æ¦‚è§ˆï¼ˆå·²å®ç°ï¼‰

### 1.1 ç½‘å…³æ€§èƒ½ä¸è´¦å·è°ƒåº¦

| çŠ¶æ€ | èƒ½åŠ› | ä»£ç è¯æ® |
|------|------|----------|
| âœ… å·²å®ç° | **SSE é˜²ç¼“å†²ï¼ˆ`X-Accel-Buffering: no`ï¼‰** | 12 å¤„è®¾ç½®ï¼Œè¦†ç›–å…¨éƒ¨ handler/serviceï¼ˆå« `gateway_*.go`ã€`*_gateway_service.go`ã€`account_test_service.go`ï¼‰ |
| âœ… å·²å®ç° | **ä¸‰å±‚è´¦å·è°ƒåº¦ï¼ˆæ¨¡å‹è·¯ç”± + ç²˜æ€§ä¼šè¯ + è´Ÿè½½æ„ŸçŸ¥/LRUï¼‰** | `gateway_service.go:1069,1324,1496` |
| âœ… å·²å®ç° | **è´¦å·çŠ¶æ€ç®¡ç†ï¼ˆé™æµ/è¿‡è½½/ä¸´æ—¶ä¸å¯è°ƒåº¦/ä¼šè¯çª—å£ï¼‰** | `service/account.go` å®Œæ•´å­—æ®µå®šä¹‰ |
| âœ… å·²å®ç° | **ä¸Šæ¸¸é”™è¯¯è‡ªåŠ¨å¤„ç†ï¼ˆ401/402/403/429/529ï¼‰** | `ratelimit_service.go:67,99,133,141,144` |
| âœ… å·²å®ç° | **é‡è¯•ç­–ç•¥ï¼ˆæŒ‡æ•°é€€é¿ + å¤±è´¥è´¦å·æ’é™¤ + è‡ªåŠ¨åˆ‡æ¢ï¼‰** | `gateway_service.go:2672,2701`ã€`gateway_handler.go:393` |
| âœ… å·²å®ç° | **TLS æŒ‡çº¹ä¼ªè£…ï¼ˆuTLS/JA3 æ¨¡æ‹Ÿ Claude CLIï¼‰** | `pkg/tlsfingerprint/dialer.go` å®Œæ•´å®ç°ï¼ˆå« SOCKS5/HTTP ä»£ç†æ”¯æŒï¼‰ |
| âœ… å·²å®ç° | **HTTP è¿æ¥æ± éš”ç¦»ï¼ˆæŒ‰ proxy URL + account IDï¼‰** | `repository/http_upstream.go:390,665,670` |
| âœ… å·²å®ç° | **ä¸Šæ¸¸é™æµå¤´é€ä¼ ** | `util/responseheaders/responseheaders.go:26-32`ï¼ˆx-ratelimit-* ç³»åˆ—åœ¨ç™½åå•ä¸­ï¼‰ |

### 1.2 å®‰å…¨ä¸è®¿é—®æ§åˆ¶

| çŠ¶æ€ | èƒ½åŠ› | ä»£ç è¯æ® |
|------|------|----------|
| âœ… å·²å®ç° | **å¤šå±‚è®¤è¯ï¼ˆAPI Key + JWT + Admin Key + TOTP 2FAï¼‰** | `middleware/api_key_auth.go`ã€`middleware/jwt_auth.go`ã€`middleware/admin_auth.go`ã€`service/totp_service.go` |
| âœ… å·²å®ç° | **JWT å®‰å…¨ç‰¹æ€§ï¼ˆç®—æ³•ç™½åå• + TokenVersion å¤±æ•ˆï¼‰** | `service/auth_service.go:724,730`ã€`middleware/jwt_auth.go:64` |
| âœ… å·²å®ç° | **é™æµï¼ˆRedis + Lua åŸå­è„šæœ¬ï¼‰** | `middleware/rate_limiter.go`ã€`service/ratelimit_service.go` |
| âœ… å·²å®ç° | **IP é»‘ç™½åå•ï¼ˆæ”¯æŒ CIDRï¼‰** | `pkg/ip/ip.go` |
| âœ… å·²å®ç° | **å®‰å…¨å“åº”å¤´ï¼ˆCSP / X-Frame-Options / X-Content-Type-Optionsï¼‰** | `middleware/security_headers.go`ï¼ˆHSTS ç”± Caddy å±‚æä¾›ï¼‰ |
| âœ… å·²å®ç° | **å¯†ç  bcrypt åŠ å¯†** | `service/auth_service.go:824,833` |

### 1.3 å¯è§‚æµ‹æ€§ä¸è¿ç»´

| çŠ¶æ€ | èƒ½åŠ› | ä»£ç è¯æ® |
|------|------|----------|
| âœ… å·²å®ç° | **å¼‚æ­¥é”™è¯¯æ—¥å¿—é˜Ÿåˆ— + Worker** | `handler/ops_error_logger.go:77,82,106,142` |
| âœ… å·²å®ç° | **è¿ç»´æŒ‡æ ‡ç³»ç»Ÿï¼ˆå»¶è¿Ÿ P50/P90/P95/P99ã€TTFTã€QPS ç­‰ï¼‰** | `service/ops_metrics_collector.go`ï¼ˆ20+ ops_* æ–‡ä»¶ï¼‰ |
| âœ… å·²å®ç° | **å‘Šè­¦ç³»ç»Ÿ + é‚®ä»¶é€šçŸ¥** | `service/ops_alert_evaluator_service.go`ã€`service/ops_scheduled_report_service.go` |
| âœ… å·²å®ç° | **å¥åº·è¯„åˆ† Dashboard** | `frontend/src/views/admin/ops/OpsDashboard.vue` |

### 1.4 äº¤ä»˜ä¸éƒ¨ç½²

| çŠ¶æ€ | èƒ½åŠ› | ä»£ç è¯æ® |
|------|------|----------|
| âœ… å·²å®ç° | **CI/CDï¼ˆGitHub Actionsï¼šå•æµ‹ + å®‰å…¨æ‰«æ + å¤šæ¶æ„å‘å¸ƒï¼‰** | `.github/workflows/backend-ci.yml`ã€`security-scan.yml`ã€`release.yml` |
| âœ… å·²å®ç° | **Docker å¤šé˜¶æ®µæ„å»º + ARM64/AMD64** | `Dockerfile`ã€`.goreleaser.yaml` |
| âœ… å·²å®ç° | **Caddy åå‘ä»£ç†ï¼ˆè‡ªåŠ¨ HTTPS + å®‰å…¨å¤´ï¼‰** | `deploy/Caddyfile` |

---

## äºŒã€å¾…å®æ–½ä¼˜åŒ–ï¼ˆçœŸæ­£çš„ Gapï¼‰

### 2.1 âš ï¸ ç½‘å…³æœ¬åœ°é™æµå“åº”å¤´ï¼ˆP0ï¼‰

**ç°çŠ¶**ï¼šä¸Šæ¸¸ API çš„ `x-ratelimit-*` å¤´å·²é€šè¿‡ç™½åå•é€ä¼ ï¼ˆ`responseheaders.go:26-32`ï¼‰ï¼Œä½†ç½‘å…³è‡ªèº«é™æµæ‹¦æˆªï¼ˆ`middleware/rate_limiter.go:132`ï¼‰ä»…è¿”å› JSON é”™è¯¯ä½“ï¼Œ**æœªè¾“å‡ºæ ‡å‡†é™æµå¤´**ã€‚

**å·®è·**ï¼šå®¢æˆ·ç«¯æ— æ³•æ„ŸçŸ¥ç½‘å…³ä¾§çš„é™æµé…é¢ä¸é‡ç½®æ—¶é—´ï¼Œæ— æ³•åšè‡ªé€‚åº”é€€é¿ã€‚

**å»ºè®®è¡¥é½çš„å“åº”å¤´**ï¼š

```http
X-RateLimit-Limit: 140
X-RateLimit-Remaining: 139
X-RateLimit-Reset: 1707650400
Retry-After: 30
```

**æ”¹é€ èŒƒå›´**ï¼š`middleware/rate_limiter.go` çš„ `abortRateLimit` å‡½æ•°ï¼Œæ”¹åŠ¨é‡å°ã€‚

### 2.2 âŒ ç«¯åˆ°ç«¯é“¾è·¯è¿½è¸ªï¼ˆP1ï¼‰

**ç°çŠ¶**ï¼š`go.mod` å­˜åœ¨ OTel é—´æ¥ä¾èµ–ï¼Œä½†ä¸šåŠ¡ä»£ç æœªæ¥å…¥ã€‚æ— æ³•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿½è¸ªå•ä¸ªè¯·æ±‚çš„å®Œæ•´é“¾è·¯ï¼ˆç½‘å…³å…¥ç«™ â†’ ä¸Šæ¸¸ API â†’ Redis/DBï¼‰ã€‚

**ä»·å€¼**ï¼šæ’æŸ¥å»¶è¿Ÿç“¶é¢ˆã€å®šä½æ…¢è¯·æ±‚æ ¹å› ã€‚

**å»ºè®®æ–¹æ¡ˆ**ï¼š

```
OTel SDKï¼ˆGoï¼‰â†’ OTLP gRPC â†’ Jaeger All-in-Oneï¼ˆDocker éƒ¨ç½²ï¼‰

æ¥å…¥ç‚¹ï¼š
â”œâ”€â”€ HTTP å…¥ç«™ä¸­é—´ä»¶ï¼ˆGin OpenTelemetry middlewareï¼‰
â”œâ”€â”€ ä¸Šæ¸¸ HTTP å‡ºç«™ï¼ˆhttp.Transport æ³¨å…¥ï¼‰
â”œâ”€â”€ Redis å®¢æˆ·ç«¯ï¼ˆgo-redis OTel hookï¼‰
â””â”€â”€ DB å®¢æˆ·ç«¯ï¼ˆEnt OTel driverï¼‰

é‡‡æ ·ç­–ç•¥ï¼š
â”œâ”€â”€ å¼€å‘ç¯å¢ƒï¼š100%
â””â”€â”€ ç”Ÿäº§ç¯å¢ƒï¼š10%ï¼ˆParentBased ä¿è¯é“¾è·¯å®Œæ•´ï¼‰
```

### è¡ŒåŠ¨æ¸…å•

| ä¼˜å…ˆçº§ | äº‹é¡¹ | æ”¹é€ èŒƒå›´ |
|--------|------|----------|
| **P0** | ç½‘å…³é™æµè¡¥é½ `X-RateLimit-*` + `Retry-After` å“åº”å¤´ | `middleware/rate_limiter.go` |
| **P1** | æ¥å…¥ OTel SDK + Jaegerï¼Œè¦†ç›– HTTP/Redis/DB span | æ–°å¢ä¸­é—´ä»¶ + Docker Compose åŠ  Jaeger |

---

## ä¸‰ã€è¿è¥å†³ç­–é¡¹ï¼ˆæŒ‰éœ€è¯„ä¼°ï¼‰

ä»¥ä¸‹ä¸æ˜¯ä»£ç ç¼ºé™·ï¼Œè€Œæ˜¯è¿è¥/åŸºç¡€è®¾æ–½å±‚é¢çš„æŠ•èµ„å†³ç­–ï¼ŒæŒ‰éœ€è¯„ä¼°ã€‚

| äº‹é¡¹ | è¯´æ˜ | å†³ç­–ä¾æ® |
|------|------|----------|
| **CDN å¤šçº¿è·¯æ¥å…¥** | å¦‚ Peekabo ä¸‰ç½‘ä¼˜åŒ– CDNã€CN2 GIA åä»£ç­‰ | å–å†³äºç”¨æˆ·åœ°åŸŸåˆ†å¸ƒä¸å»¶è¿Ÿæ•æ„Ÿåº¦ |
| **æµ·å¤–è¾¹ç¼˜åŠ é€Ÿ** | AWS Global Accelerator ç­‰ | å–å†³äºæµ·å¤–ç”¨æˆ·å æ¯”ä¸é¢„ç®— |
| **Jaeger åç«¯é€‰å‹** | Jaeger All-in-One / Grafana Tempo / äº‘æ‰˜ç®¡ | å–å†³äºæ•°æ®é‡ä¸è¿ç»´èƒ½åŠ› |

**è´¹ç”¨å‚è€ƒï¼ˆ88code æ–¹æ¡ˆï¼‰**ï¼š

| æ–¹æ¡ˆ | æœˆè´¹ | ä¸­å›½åŠ é€Ÿæ•ˆæœ | ç»´æŠ¤éš¾åº¦ |
|------|------|------------|---------|
| Peekabo CDNï¼ˆæ—¥æœ¬/é¦™æ¸¯ï¼‰ | ~70-100 | å¥½ | æœ€ç®€å•ï¼ˆæ”¹ DNSï¼‰ |
| CN2 GIA VPS + åä»£ | ~20-200 | æœ€å¥½ | éœ€é…ç½®åä»£ |
| AWS Global Accelerator | ~150-250 | ä¸€èˆ¬ | ä¸­ç­‰ |
| Cloudflare å…è´¹ç‰ˆ | å…è´¹ | å·®ï¼ˆä¸­å›½çº¿è·¯å·®ï¼‰ | å·²å¯ç”¨ |

---

## é™„å½• Aï¼š88code æ¶æ„å‚è€ƒï¼ˆä¸ç›´æ¥é€‚ç”¨ï¼‰

> 88code åŸºäº Nginx + K8s æŠ€æœ¯æ ˆã€‚Sub2API é»˜è®¤ä½¿ç”¨ Caddy + Docker Composeï¼ˆä¹Ÿæ”¯æŒè£¸éƒ¨ç½²ç›´å‡º 8080ï¼‰ï¼Œ**ä»¥ä¸‹é…ç½®ä¸å¯ç›´æ¥å¥—ç”¨**ï¼Œä»…ä½œæ¶æ„æ€è·¯å‚è€ƒã€‚

### A.1 ğŸš« Nginx SSE ä¼˜åŒ–é…ç½®

88code åœ¨ Nginx å±‚çš„é˜²ç¼“å†²é…ç½®ï¼ˆSub2API ä½¿ç”¨ Caddyï¼Œæ— éœ€æ­¤é…ç½®ï¼‰ï¼š

```nginx
proxy_buffering off;
proxy_cache off;
proxy_http_version 1.1;
proxy_set_header Connection '';
proxy_read_timeout 600s;
keepalive_timeout 3000s;
```

### A.2 ğŸš« Nginx é«˜å¹¶å‘è°ƒä¼˜

```nginx
worker_processes auto;
events { worker_connections 14000; }
http {
    sendfile on;
    tcp_nopush on;
    client_max_body_size 1024m;
}
```

### A.3 ğŸš« K8s éƒ¨ç½²é…ç½®

88code çš„ K8s éƒ¨ç½²å‚æ•°ï¼ˆSub2API ä½¿ç”¨ Docker Composeï¼Œä¸é€‚ç”¨ï¼‰ï¼š

| æœåŠ¡ | å‰¯æœ¬ | CPU è¯·æ±‚/é™åˆ¶ | å†…å­˜ è¯·æ±‚/é™åˆ¶ |
|------|------|-------------|-------------|
| Backend | 4 | 1.2 / 3 æ ¸ | 4.5G / 8G |
| Gateway | 2 | 0.1 / 0.5 æ ¸ | 64M / 256M |
| Frontend | 4 | 0.15 / 0.5 æ ¸ | 256M / 1G |

### A.4 ğŸš« K8s é›¶åœæœºæ›´æ–°ä¸æ¢é’ˆ

```yaml
# æ»šåŠ¨æ›´æ–°ç­–ç•¥
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

# ä¼˜é›…å…³é—­
lifecycle:
  preStop:
    exec:
      command: ["sleep", "15"]
```

### A.5 ğŸš« K8s æ—¥å¿—æ”¶é›†

```
K8s Pod æ—¥å¿— â†’ Fluent Bit DaemonSet â†’ AWS CloudWatch Logs
```

å¦‚æœªæ¥è¿ç§»åˆ° K8sï¼Œä»¥ä¸Šé…ç½®å¯ä½œä¸ºèµ·ç‚¹å‚è€ƒã€‚

---

## é™„å½• Bï¼šæŠ€æœ¯æ ˆå¯¹æ¯”ï¼ˆä¿®æ­£ç‰ˆï¼‰

| ç»´åº¦ | Sub2APIï¼ˆäº‹å®ï¼‰ | 88code | è¯´æ˜ |
|------|----------------|--------|------|
| åç«¯è¯­è¨€ | Go å•ä½“ï¼ˆGin + Entï¼‰ | Java + Go Gateway | - |
| æœåŠ¡é€šä¿¡ | HTTP/JSON + SSE | gRPC + HTTP | - |
| æ•°æ®åº“ | PostgreSQL | MySQL | - |
| ç¼“å­˜ | Redis | Redis | - |
| åå‘ä»£ç† | **Caddy**ï¼ˆè‡ªåŠ¨ HTTPSï¼‰ | Nginx | Sub2API æ— éœ€æ‰‹åŠ¨ç®¡ç†è¯ä¹¦ |
| éƒ¨ç½²æ–¹å¼ | **Docker Compose** | Kubernetes | - |
| CI/CD | **GitHub Actions å…¨è‡ªåŠ¨**ï¼ˆCI + å®‰å…¨æ‰«æ + å¤šæ¶æ„å‘å¸ƒï¼‰ | GitHub Actions å…¨è‡ªåŠ¨ | ~~åŸæ–‡è¯¯æ ‡ä¸º"æ‰‹åŠ¨/GoReleaser"~~ |
| ç›‘æ§ | **è‡ªå»º Ops ä½“ç³»**ï¼ˆ20+ æ–‡ä»¶ï¼Œå»¶è¿Ÿåˆ†ä½/TTFT/å‘Šè­¦/é‚®ä»¶/Dashboardï¼‰ | OTel + Jaeger + è‡ªå»º Ops | ~~åŸæ–‡è¯¯æ ‡ä¸º"åŸºç¡€"~~ |
| é“¾è·¯è¿½è¸ª | æœªæ¥å…¥ï¼ˆGapï¼‰ | OTel ç«¯åˆ°ç«¯ | å¾…å®æ–½ |
| é™æµå¯è§‚æµ‹ | ä¸Šæ¸¸å¤´é€ä¼ å·²æœ‰ï¼Œç½‘å…³æœ¬åœ°å¤´å¾…è¡¥é½ | å®Œæ•´ X-RateLimit è¾“å‡º | å¾…è¡¥é½ |
| TLS æŒ‡çº¹ | **å·²å®ç°**ï¼ˆutls/JA3ï¼‰ | å·²å®ç° | ~~åŸæ–‡è¯¯æ ‡ä¸º"å¾…å¼•å…¥"~~ |
| å¤šæ¶æ„å‘å¸ƒ | **å·²å®ç°**ï¼ˆARM64 + AMD64ï¼‰ | å·²å®ç° | - |

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šå·®å¼‚å¯¹ç…§ç‰ˆ v2.0ï¼ˆæ›¿ä»£åŸè¯¯å¯¼æ€§æ‰§è¡Œæ¸…å•ï¼‰*
*å‚è€ƒé¡¹ç›®ï¼š88code (byebyecode)*
*æ›´æ–°æ—¥æœŸï¼š2026-02-12*
